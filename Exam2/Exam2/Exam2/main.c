//Julian Kemmerer
//Exam 2
//ECEC 356
//8/11/11

//----------------------------------------------------------------------------
// C main line
//----------------------------------------------------------------------------

#include <m8c.h>        // part specific constants and macros
#include "PSoCAPI.h"    // PSoC API definitions for all User Modules

const char SineTable[] = {
128,129,130,130,131,132,133,133,134,135,136,136,137,138,138,139,
140,141,141,142,143,143,144,145,145,146,146,147,148,148,149,149,
150,150,151,151,152,152,153,153,154,154,155,155,155,156,156,156,
157,157,157,157,158,158,158,158,158,159,159,159,159,159,159,159,
159,159,159,159,159,159,159,159,158,158,158,158,158,157,157,157,
157,156,156,156,155,155,155,154,154,153,153,152,152,151,151,150,
150,149,149,148,148,147,146,146,145,145,144,143,143,142,141,141,
140,139,138,138,137,136,136,135,134,133,133,132,131,130,130,129,
128,161,162,162,163,164,165,165,166,167,168,168,169,170,170,171,
172,173,173,174,175,175,176,177,177,178,178,179,180,180,181,181,
182,182,183,183,184,184,185,185,186,186,187,187,187,188,188,188,
189,189,189,189,190,190,190,190,190,191,191,191,191,191,191,191,
191,191,191,191,191,191,191,191,190,190,190,190,190,189,189,189,
189,188,188,188,187,187,187,186,186,185,185,184,184,183,183,182,
182,181,181,180,180,179,178,178,177,177,176,175,175,174,173,173,
172,171,170,170,169,168,168,167,166,165,165,164,163,162,162,161
};


const char SineTableRect[] = {128,	161,	162,	162,	163,	164,	165,	165,	166,	167,	168,	168,	169,	170,	170,	171,	172,	173,	173,	174,	175,	175,	176,	177,	177,	178,	178,	179,	180,	180,	181,	181,	182,	182,	183,	183,	184,	184,	185,	185,	186,	186,	187,	187,	187,	188,	188,	188,	189,	189,	189,	189,	190,	190,	190,	190,	190,	191,	191,	191,	191,	191,	191,	191,	191,	191,	191,	191,	191,	191,	191,	191,	190,	190,	190,	190,	190,	189,	189,	189,	189,	188,	188,	188,	187,	187,	187,	186,	186,	185,	185,	184,	184,	183,	183,	182,	182,	181,	181,	180,	180,	179,	178,	178,	177,	177,	176,	175,	175,	174,	173,	173,	172,	171,	170,	170,	169,	168,	168,	167,	166,	165,	165,	164,	163,	162,	162,	161,	160,	161,	162,	162,	163,	164,	165,	165,	166,	167,	168,	168,	169,	170,	170,	171,	172,	173,	173,	174,	175,	175,	176,	177,	177,	178,	178,	179,	180,	180,	181,	181,	182,	182,	183,	183,	184,	184,	185,	185,	186,	186,	187,	187,	187,	188,	188,	188,	189,	189,	189,	189,	190,	190,	190,	190,	190,	191,	191,	191,	191,	191,	191,	191,	191,	191,	191,	191,	191,	191,	191,	191,	190,	190,	190,	190,	190,	189,	189,	189,	189,	188,	188,	188,	187,	187,	187,	186,	186,	185,	185,	184,	184,	183,	183,	182,	182,	181,	181,	180,	180,	179,	178,	178,	177,	177,	176,	175,	175,	174,	173,	173,	172,	171,	170,	170,	169,	168,	168,	167,	166,	165,	165,	164,	163,	162,	162,	161};


//const char SineTable[] = {31,	32,	33,	33,	34,	35,	36,	36,	37,	38,	39,	39,	40,	41,	41,	42,	43,	44,	44,	45,	46,	46,	47,	48,	48,	49,	49,	50,	51,	51,	52,	52,	53,	53,	54,	54,	55,	55,	56,	56,	57,	57,	58,	58,	58,	59,	59,	59,	60,	60,	60,	60,	61,	61,	61,	61,	61,	62,	62,	62,	62,	62,	62,	62,	62,	62,	62,	62,	62,	62,	62,	62,	61,	61,	61,	61,	61,	60,	60,	60,	60,	59,	59,	59,	58,	58,	58,	57,	57,	56,	56,	55,	55,	54,	54,	53,	53,	52,	52,	51,	51,	50,	49,	49,	48,	48,	47,	46,	46,	45,	44,	44,	43,	42,	41,	41,	40,	39,	39,	38,	37,	36,	36,	35,	34,	33,	33,	32,	31,	30,	29,	29,	28,	27,	26,	26,	25,	24,	23,	23,	22,	21,	21,	20,	19,	18,	18,	17,	16,	16,	15,	14,	14,	13,	13,	12,	11,	11,	10,	10,	9,	9,	8,	8,	7,	7,	6,	6,	5,	5,	4,	4,	4,	3,	3,	3,	2,	2,	2,	2,	1,	1,	1,	1,	1,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	1,	1,	1,	1,	1,	2,	2,	2,	2,	3,	3,	3,	4,	4,	4,	5,	5,	6,	6,	7,	7,	8,	8,	9,	9,	10,	10,	11,	11,	12,	13,	13,	14,	14,	15,	16,	16,	17,	18,	18,	19,	20,	21,	21,	22,	23,	23,	24,	25,	26,	26,	27,	28,	29,	29,	30};


// Variable to hold the index into the lookup table
BYTE Pointer;

int sinefreq = 0;
int CountPeriod = 0;
extern char phaseShift = (256/4); //Arbitrary


void main(void)
{
	M8C_EnableGInt ; // Uncomment this line to enable Global Interrupts
	
	//Start LCD
	LCD_Start();
	LCD_Init();
		LCD_Position(0,0);
	LCD_PrCString("TEst");
	// Starts the Counter16 User Module and enable its interrupt.
	Counter16_Start();			
	Counter16_EnableInt();
	
	
	//Change period
	CountPeriod = 480;
	Counter16_WritePeriod(CountPeriod);
	
	// Start the SCDAC at high power
	SCDAC_Start(SCDAC_HIGHPOWER);
	
	//Clear freq
	sinefreq = 0;
	

	
	//Control loop
	while(1)
	{
		//wait for
		//If button is pressed	
		if( (PRT1DR & 0b00000001) == 0b00000001)
		{
			//Wait for release
			while((PRT1DR & 0b00000001) == 0b00000001){}
			CountPeriod+10;
			Counter16_WritePeriod(CountPeriod);
		}
		
		//the frequency of the sine wave with 256 samples
		sinefreq = (24000000/CountPeriod)/256;
		
		//Print freq
		LCD_Position(0,0);
		LCD_PrHexInt(sinefreq);
	}
}
#pragma interrupt_handler CounterISR
// Counter16 interrupt handler
void CounterISR(void)
{
	// Update the DAC with the value in lookup table pointed the variable Pointer
	SCDAC_cr0 = (SineTableRect[Pointer]); 
	
	// Increment pointer
    Pointer++;Pointer++;Pointer++;Pointer++; //4 times for x4
	
	// If the Pointer is incremented by 2, the effective number of samples will be
    // 128 and the output frequency will be doubled.  If Pointer is incremented by 4,
    // number of samples will be 64 and the output frequency will be quadrupled.
    
	// Reset Pointer if greater than or equal to 64
    if (Pointer >= 255) Pointer = 0;
}
